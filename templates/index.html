<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XQL Hub</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <!-- CSP meta tag for additional XSS protection -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://unpkg.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com;">
</head>
<body>

    <header>
        <a href="/" class="logo">XQL <span>HUB</span></a>
        <div class="header-controls">
            <div class="search-bar">
                <input type="text" name="q" id="search-input"
                       placeholder="Search queries..."
                       maxlength="500"
                       autocomplete="off">
            </div>
            <a href="/contribute" class="contribute-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Contribute
            </a>
        </div>
    </header>

    <div class="app-layout">
        <!-- Left Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-section">
                <h4 class="sidebar-title">Filters</h4>

                <div class="filter-group">
                    <label for="filter-content-type">Content Type</label>
                    <select name="content_type" id="filter-content-type" class="filter-select">
                        <option value="all">All Types</option>
                        {% for t in filters.types %}
                        <option value="{{ t }}">
                            {% if t == 'bioc' %}BIOC
                            {% elif t == 'hunting' %}Threat Hunting
                            {% elif t == 'hygiene' %}IT Hygiene
                            {% elif t == 'correlation' %}Correlation Rule
                            {% elif t == 'widget' %}Dashboard Widget
                            {% else %}{{ t|title }}
                            {% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label for="filter-log-source">Log Source</label>
                    <select name="log_source" id="filter-log-source" class="filter-select">
                        <option value="all">All Log Sources</option>
                        {% for ls in filters.log_sources %}
                        <option value="{{ ls }}">{{ ls }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label for="filter-sort">Sort By</label>
                    <select name="sort_by" id="filter-sort" class="filter-select">
                        <option value="name">Name (A-Z)</option>
                        <option value="name-desc">Name (Z-A)</option>
                        <option value="severity">Severity (High first)</option>
                        <option value="type">Content Type</option>
                    </select>
                </div>
            </div>

            <div class="sidebar-section">
                <button type="button" class="clear-filters-btn" id="clear-filters-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 6h18M6 6v14a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V6M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/>
                    </svg>
                    Clear All Filters
                </button>
            </div>

            <!-- Contribute CTA in sidebar -->
            <div class="sidebar-section sidebar-cta">
                <div class="cta-card">
                    <div class="cta-icon">üéÅ</div>
                    <h4>Share Your Queries</h4>
                    <p>Help the community by contributing your detection content.</p>
                    <a href="/contribute" class="cta-btn">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        Contribute Now
                    </a>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <div class="main-area">
            <!-- MITRE ATT&CK Matrix -->
            <div class="mitre-matrix-container">
                <div class="mitre-matrix-header">
                    <h3>MITRE ATT&CK Matrix</h3>
                    <div class="mitre-stats">
                        <span class="stat-pill"><strong id="total-queries">{{ queries|length }}</strong> Queries</span>
                        <span class="stat-pill"><strong id="tactic-count">0</strong> Tactics</span>
                        <span class="stat-pill"><strong id="technique-count">0</strong> Techniques</span>
                    </div>
                </div>

                <div class="tactics-row" id="tactics-row">
                    <!-- Tactics will be populated by JS -->
                </div>

                <div class="selected-techniques" id="selected-display">
                    <span class="selected-label">Active Filters:</span>
                    <div class="selected-tags" id="selected-tags"></div>
                </div>
            </div>

            <!-- Main Content -->
            <main class="main-content">
                <div id="results-grid" class="grid">
                    {% include "partials/query_cards.html" %}
                </div>
            </main>
        </div>
    </div>

    <script>
    (function() {
        'use strict';

        // =============================================================================
        // SECURITY UTILITIES
        // =============================================================================

        /**
         * Validates a MITRE technique ID format
         * @param {string} id - The ID to validate
         * @returns {boolean} - True if valid format
         */
        function isValidMitreId(id) {
            if (typeof id !== 'string') return false;
            // Strict pattern: T followed by 4 digits, optionally .3 digits
            return /^T\d{4}(\.\d{3})?$/.test(id);
        }

        /**
         * Validates a MITRE tactic ID format
         * @param {string} id - The ID to validate
         * @returns {boolean} - True if valid format
         */
        function isValidTacticId(id) {
            if (typeof id !== 'string') return false;
            // Pattern: TA followed by 4 digits
            return /^TA\d{4}$/.test(id);
        }

        /**
         * Sanitizes a string for safe use in text content
         * @param {*} input - The input to sanitize
         * @returns {string} - Sanitized string
         */
        function sanitizeText(input) {
            if (input === null || input === undefined) return '';
            return String(input);
        }

        /**
         * Escapes HTML entities to prevent XSS when inserting into HTML
         * @param {string} text - The text to escape
         * @returns {string} - Escaped text
         */
        function escapeHtml(text) {
            const str = sanitizeText(text);
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        /**
         * Creates a text node safely
         * @param {string} text - The text content
         * @returns {Text} - Text node
         */
        function createTextNode(text) {
            return document.createTextNode(sanitizeText(text));
        }

        /**
         * Safely gets an element by ID with validation
         * @param {string} id - Element ID
         * @returns {Element|null} - The element or null
         */
        function getElement(id) {
            if (typeof id !== 'string' || !id) {
                console.warn('Invalid element ID provided');
                return null;
            }
            return document.getElementById(id);
        }

        /**
         * Safely gets an element's value
         * @param {string} id - Element ID
         * @param {string} defaultValue - Default value if element not found
         * @returns {string} - The value
         */
        function getElementValue(id, defaultValue) {
            if (defaultValue === undefined) defaultValue = '';
            var el = getElement(id);
            return el ? (el.value || defaultValue) : defaultValue;
        }

        /**
         * Safely query elements by attribute with validated value
         * @param {string} attr - Attribute name
         * @param {string} value - Attribute value (will be validated/escaped)
         * @returns {NodeList} - Matching elements
         */
        function queryByAttribute(attr, value) {
            if (typeof attr !== 'string' || typeof value !== 'string') {
                return [];
            }
            try {
                // CSS.escape handles special characters safely
                var selector = '[' + CSS.escape(attr) + '="' + CSS.escape(value) + '"]';
                return document.querySelectorAll(selector);
            } catch (e) {
                console.error('Query selector error:', e);
                return [];
            }
        }

        // =============================================================================
        // DATA INITIALIZATION WITH VALIDATION
        // =============================================================================

        // Parse and validate queries from server
        var allQueries = (function() {
            try {
                var data = {{ queries | tojson }};
                if (!Array.isArray(data)) {
                    console.error('Queries data is not an array');
                    return [];
                }
                // Validate each query has expected structure
                return data.filter(function(q) {
                    return q && typeof q === 'object' &&
                           typeof q.name === 'string' &&
                           typeof q.content_type === 'string';
                });
            } catch (e) {
                console.error('Failed to parse queries data:', e);
                return [];
            }
        })();

        // Parse and validate MITRE data from server
        var mitreData = (function() {
            try {
                var data = {{ mitre_data | tojson }};
                if (!data || typeof data !== 'object' || Array.isArray(data)) {
                    console.error('MITRE data is not a valid object');
                    return {};
                }
                // Validate structure - should be {techniqueId: {name, tactic_ids}}
                var validated = {};
                for (var key in data) {
                    if (data.hasOwnProperty(key) && isValidMitreId(key)) {
                        var value = data[key];
                        if (value && typeof value === 'object') {
                            validated[key] = {
                                name: typeof value.name === 'string' ? value.name : key,
                                tactic_ids: Array.isArray(value.tactic_ids)
                                    ? value.tactic_ids.filter(isValidTacticId)
                                    : []
                            };
                        }
                    }
                }
                return validated;
            } catch (e) {
                console.error('Failed to parse MITRE data:', e);
                return {};
            }
        })();

        // Tactic definitions (static, trusted data)
        var tactics = [
            { id: 'TA0043', name: 'Reconnaissance', shortname: 'Reconnaissance' },
            { id: 'TA0042', name: 'Resource Development', shortname: 'Resource Dev' },
            { id: 'TA0001', name: 'Initial Access', shortname: 'Initial Access' },
            { id: 'TA0002', name: 'Execution', shortname: 'Execution' },
            { id: 'TA0003', name: 'Persistence', shortname: 'Persistence' },
            { id: 'TA0004', name: 'Privilege Escalation', shortname: 'Priv Escalation' },
            { id: 'TA0005', name: 'Defense Evasion', shortname: 'Defense Evasion' },
            { id: 'TA0006', name: 'Credential Access', shortname: 'Cred Access' },
            { id: 'TA0007', name: 'Discovery', shortname: 'Discovery' },
            { id: 'TA0008', name: 'Lateral Movement', shortname: 'Lateral Move' },
            { id: 'TA0009', name: 'Collection', shortname: 'Collection' },
            { id: 'TA0011', name: 'Command and Control', shortname: 'C2' },
            { id: 'TA0010', name: 'Exfiltration', shortname: 'Exfiltration' },
            { id: 'TA0040', name: 'Impact', shortname: 'Impact' }
        ];
        Object.freeze(tactics);

        // =============================================================================
        // STATE MANAGEMENT
        // =============================================================================

        // Use Sets for efficient lookups
        var selectedMitre = new Set();
        var expandedTactics = new Set();

        // =============================================================================
        // MITRE DATA FUNCTIONS
        // =============================================================================

        /**
         * Get tactic IDs for a technique (supports many-to-many)
         */
        function getTacticIdsForTechnique(techniqueId) {
            if (!isValidMitreId(techniqueId)) return [];
            var baseId = techniqueId.split('.')[0];
            var entry = mitreData[techniqueId] || mitreData[baseId];
            return entry ? entry.tactic_ids : [];
        }

        /**
         * Get technique name from MITRE data
         */
        function getTechniqueName(techniqueId) {
            if (!isValidMitreId(techniqueId)) return escapeHtml(techniqueId);
            var entry = mitreData[techniqueId];
            if (entry && entry.name) return entry.name;
            var baseId = techniqueId.split('.')[0];
            var baseEntry = mitreData[baseId];
            if (baseEntry && baseEntry.name) return baseEntry.name;
            return techniqueId;
        }

        /**
         * Get currently filtered queries based on dropdown selections
         */
        function getFilteredQueries() {
            var contentType = getElementValue('filter-content-type', 'all');
            var logSource = getElementValue('filter-log-source', 'all');
            var searchQuery = getElementValue('search-input', '').toLowerCase().slice(0, 500);

            return allQueries.filter(function(q) {
                if (contentType !== 'all' && q.content_type !== contentType) return false;
                if (logSource !== 'all') {
                    var sources = Array.isArray(q.log_sources) ? q.log_sources : [];
                    if (sources.indexOf(logSource) === -1) return false;
                }
                if (searchQuery) {
                    var tags = Array.isArray(q.tags) ? q.tags : [];
                    var searchableText = [
                        q.name || '',
                        q.description || '',
                        q.author || ''
                    ].concat(tags).join(' ').toLowerCase();
                    if (searchableText.indexOf(searchQuery) === -1) return false;
                }
                return true;
            });
        }

        /**
         * Get MITRE IDs from filtered queries
         */
        function getMitreFromFilteredQueries() {
            var filtered = getFilteredQueries();
            var mitreIds = new Set();
            filtered.forEach(function(q) {
                var ids = Array.isArray(q.mitre_ids) ? q.mitre_ids : [];
                ids.forEach(function(mid) {
                    if (isValidMitreId(mid)) {
                        mitreIds.add(mid);
                    }
                });
            });
            return Array.from(mitreIds);
        }

        /**
         * Count queries matching a specific technique
         */
        function countQueriesForTechnique(techniqueId) {
            if (!isValidMitreId(techniqueId)) return 0;
            var filtered = getFilteredQueries();
            return filtered.filter(function(q) {
                var queryMitre = Array.isArray(q.mitre_ids) ? q.mitre_ids : [];
                return queryMitre.some(function(mid) {
                    return isValidMitreId(mid) && (mid === techniqueId || mid.indexOf(techniqueId + '.') === 0);
                });
            }).length;
        }

        // =============================================================================
        // DOM BUILDING FUNCTIONS (Using safe DOM methods)
        // =============================================================================

        /**
         * Build the MITRE matrix based on current filters
         */
        function buildMitreMatrix() {
            var tacticsRow = getElement('tactics-row');
            if (!tacticsRow) {
                console.error('tactics-row element not found');
                return;
            }

            var availableMitre = getMitreFromFilteredQueries();
            var tacticCounts = {};
            var tacticTechniques = {};
            var uniqueTechniques = new Set();

            // Initialize all tactics
            tactics.forEach(function(t) {
                tacticCounts[t.id] = 0;
                tacticTechniques[t.id] = new Map();
            });

            // Group techniques by tactic
            availableMitre.forEach(function(mid) {
                if (!isValidMitreId(mid)) return;
                var baseId = mid.split('.')[0];
                uniqueTechniques.add(baseId);
                var tacticIds = getTacticIdsForTechnique(mid);

                tacticIds.forEach(function(tacticId) {
                    if (!isValidTacticId(tacticId)) return;
                    if (!tacticTechniques[tacticId]) {
                        tacticTechniques[tacticId] = new Map();
                    }
                    if (!tacticTechniques[tacticId].has(baseId)) {
                        tacticTechniques[tacticId].set(baseId, []);
                    }
                    tacticTechniques[tacticId].get(baseId).push(mid);
                });
            });

            // Count unique techniques per tactic
            Object.keys(tacticTechniques).forEach(function(tacticId) {
                tacticCounts[tacticId] = tacticTechniques[tacticId].size;
            });

            // Clear and rebuild the UI using safe DOM methods
            tacticsRow.innerHTML = '';
            var totalTactics = 0;

            tactics.forEach(function(tactic) {
                var count = tacticCounts[tactic.id] || 0;
                var techniques = tacticTechniques[tactic.id];
                if (count > 0) totalTactics++;

                var column = document.createElement('div');
                column.className = 'tactic-column';
                column.setAttribute('data-tactic-id', tactic.id);

                var hasQueries = count > 0;
                var isExpanded = expandedTactics.has(tactic.id);

                // Build header using DOM methods (safer than innerHTML)
                var header = document.createElement('div');
                header.className = 'tactic-header' + (hasQueries ? ' has-queries' : '') + (isExpanded ? ' expanded' : '');
                header.setAttribute('data-tactic-id', tactic.id);

                var countSpan = document.createElement('span');
                countSpan.className = 'tactic-count ' + (hasQueries ? 'has-queries' : 'zero');
                countSpan.textContent = count;
                header.appendChild(countSpan);

                var nameSpan = document.createElement('span');
                nameSpan.className = 'tactic-name';
                nameSpan.textContent = tactic.shortname;
                header.appendChild(nameSpan);

                var idSpan = document.createElement('span');
                idSpan.className = 'tactic-id';
                idSpan.textContent = tactic.id;
                header.appendChild(idSpan);

                if (hasQueries) {
                    var indicator = document.createElement('span');
                    indicator.className = 'tactic-expand-indicator';
                    indicator.textContent = '‚ñº';
                    header.appendChild(indicator);
                }

                column.appendChild(header);

                // Build techniques panel
                var panel = document.createElement('div');
                panel.className = 'techniques-panel' + (isExpanded ? ' expanded' : '');
                panel.id = 'panel-' + tactic.id;

                if (techniques && techniques.size > 0) {
                    techniques.forEach(function(subtechniques, baseId) {
                        if (!isValidMitreId(baseId)) return;

                        var name = getTechniqueName(baseId);
                        var queryCount = countQueriesForTechnique(baseId);
                        var isSelected = selectedMitre.has(baseId);

                        var card = document.createElement('div');
                        card.className = 'technique-card' + (isSelected ? ' selected' : '');
                        card.setAttribute('data-technique', baseId);
                        card.title = name + ' (' + baseId + ')';

                        var cardHeader = document.createElement('div');
                        cardHeader.className = 'technique-card-header';

                        var cardName = document.createElement('span');
                        cardName.className = 'technique-card-name';
                        cardName.textContent = name;
                        cardHeader.appendChild(cardName);

                        var cardCount = document.createElement('span');
                        cardCount.className = 'technique-card-count';
                        cardCount.textContent = queryCount;
                        cardHeader.appendChild(cardCount);

                        card.appendChild(cardHeader);

                        var cardId = document.createElement('span');
                        cardId.className = 'technique-card-id';
                        cardId.textContent = baseId;
                        card.appendChild(cardId);

                        panel.appendChild(card);
                    });
                }

                column.appendChild(panel);
                tacticsRow.appendChild(column);
            });

            // Update stats
            var tacticCountEl = getElement('tactic-count');
            var techniqueCountEl = getElement('technique-count');
            var totalQueriesEl = getElement('total-queries');

            if (tacticCountEl) tacticCountEl.textContent = totalTactics;
            if (techniqueCountEl) techniqueCountEl.textContent = uniqueTechniques.size;
            if (totalQueriesEl) totalQueriesEl.textContent = getFilteredQueries().length;
        }

        /**
         * Toggle a tactic's expanded state
         */
        function toggleTactic(tacticId) {
            if (!isValidTacticId(tacticId)) return;

            var columns = queryByAttribute('data-tactic-id', tacticId);
            if (columns.length === 0) return;

            var column = columns[0];
            var header = column.querySelector('.tactic-header');
            var panel = getElement('panel-' + tacticId);

            if (!header || !panel || !header.classList.contains('has-queries')) return;

            if (expandedTactics.has(tacticId)) {
                expandedTactics.delete(tacticId);
                header.classList.remove('expanded');
                panel.classList.remove('expanded');
            } else {
                expandedTactics.add(tacticId);
                header.classList.add('expanded');
                panel.classList.add('expanded');
            }
        }

        /**
         * Toggle a technique's selected state
         */
        function toggleTechnique(techniqueId) {
            if (!isValidMitreId(techniqueId)) return;

            var cards = queryByAttribute('data-technique', techniqueId);

            if (selectedMitre.has(techniqueId)) {
                selectedMitre.delete(techniqueId);
                Array.prototype.forEach.call(cards, function(c) {
                    c.classList.remove('selected');
                });
            } else {
                selectedMitre.add(techniqueId);
                Array.prototype.forEach.call(cards, function(c) {
                    c.classList.add('selected');
                });
            }

            updateSelectedDisplay();
            triggerSearch();
        }

        /**
         * Update the selected techniques display
         */
        function updateSelectedDisplay() {
            var display = getElement('selected-display');
            var tagsContainer = getElement('selected-tags');

            if (!display || !tagsContainer) return;

            if (selectedMitre.size === 0) {
                display.classList.remove('has-selection');
                tagsContainer.innerHTML = '';
            } else {
                display.classList.add('has-selection');
                tagsContainer.innerHTML = '';

                selectedMitre.forEach(function(mid) {
                    if (!isValidMitreId(mid)) return;

                    var name = getTechniqueName(mid);
                    var tag = document.createElement('span');
                    tag.className = 'selected-tag';
                    tag.setAttribute('data-technique', mid);
                    tag.textContent = name + ' ';

                    var removeSpan = document.createElement('span');
                    removeSpan.className = 'remove';
                    removeSpan.textContent = '√ó';
                    tag.appendChild(removeSpan);

                    tagsContainer.appendChild(tag);
                });
            }
        }

        /**
         * Clear all filters and selections
         */
        function clearAllFilters() {
            selectedMitre.clear();
            expandedTactics.clear();

            var cards = document.querySelectorAll('.technique-card.selected');
            Array.prototype.forEach.call(cards, function(el) {
                el.classList.remove('selected');
            });

            var contentTypeEl = getElement('filter-content-type');
            var logSourceEl = getElement('filter-log-source');
            var sortEl = getElement('filter-sort');
            var searchEl = getElement('search-input');

            if (contentTypeEl) contentTypeEl.value = 'all';
            if (logSourceEl) logSourceEl.value = 'all';
            if (sortEl) sortEl.value = 'name';
            if (searchEl) searchEl.value = '';

            updateSelectedDisplay();
            buildMitreMatrix();
            triggerSearch();
        }

        /**
         * Handle filter changes
         */
        function onFilterChange() {
            buildMitreMatrix();
            triggerSearch();
        }

        /**
         * Trigger HTMX search with current filters
         */
        function triggerSearch() {
            var params = new URLSearchParams();

            var q = getElementValue('search-input', '').slice(0, 500);
            if (q) params.append('q', q);

            var contentType = getElementValue('filter-content-type', 'all');
            if (contentType && contentType !== 'all') params.append('content_type', contentType);

            var logSource = getElementValue('filter-log-source', 'all');
            if (logSource && logSource !== 'all') params.append('log_source', logSource);

            var sortBy = getElementValue('filter-sort', 'name');
            params.append('sort_by', sortBy);

            selectedMitre.forEach(function(mid) {
                if (isValidMitreId(mid)) {
                    params.append('mitre', mid);
                }
            });

            // Check if htmx is available
            if (typeof htmx !== 'undefined' && htmx.ajax) {
                htmx.ajax('GET', '/search?' + params.toString(), '#results-grid');
            } else {
                console.warn('htmx not available, falling back to page reload');
                window.location.href = '/search?' + params.toString();
            }
        }

        /**
         * Filter by tag (called from query cards)
         */
        function filterByTag(tag) {
            var searchEl = getElement('search-input');
            if (searchEl && typeof tag === 'string') {
                searchEl.value = tag.slice(0, 500);
                onFilterChange();
            }
        }

        /**
         * Filter by log source (called from query cards)
         */
        function filterByLogSource(logSource) {
            var logSourceEl = getElement('filter-log-source');
            if (logSourceEl && typeof logSource === 'string') {
                // Only set if it's a valid option
                var options = Array.from(logSourceEl.options);
                var validOption = options.find(function(opt) {
                    return opt.value === logSource;
                });
                if (validOption) {
                    logSourceEl.value = logSource;
                    onFilterChange();
                }
            }
        }

        // =============================================================================
        // EVENT LISTENERS (Using delegation for dynamic content)
        // =============================================================================

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize
            try {
                buildMitreMatrix();
                triggerSearch();
            } catch (e) {
                console.error('Error initializing MITRE matrix:', e);
            }

            // Event delegation for tactics row
            var tacticsRow = getElement('tactics-row');
            if (tacticsRow) {
                tacticsRow.addEventListener('click', function(e) {
                    // Handle tactic header clicks
                    var header = e.target.closest('.tactic-header');
                    if (header) {
                        var tacticId = header.getAttribute('data-tactic-id');
                        if (tacticId) {
                            toggleTactic(tacticId);
                            return;
                        }
                    }

                    // Handle technique card clicks
                    var card = e.target.closest('.technique-card');
                    if (card) {
                        var techniqueId = card.getAttribute('data-technique');
                        if (techniqueId) {
                            toggleTechnique(techniqueId);
                            return;
                        }
                    }
                });
            }

            // Event delegation for selected tags
            var selectedTags = getElement('selected-tags');
            if (selectedTags) {
                selectedTags.addEventListener('click', function(e) {
                    var tag = e.target.closest('.selected-tag');
                    if (tag) {
                        var techniqueId = tag.getAttribute('data-technique');
                        if (techniqueId) {
                            toggleTechnique(techniqueId);
                        }
                    }
                });
            }

            // Filter change listeners
            var filterElements = ['filter-content-type', 'filter-log-source', 'filter-sort'];
            filterElements.forEach(function(id) {
                var el = getElement(id);
                if (el) {
                    el.addEventListener('change', onFilterChange);
                }
            });

            // Search input with debounce
            var searchInput = getElement('search-input');
            if (searchInput) {
                var debounceTimer;
                searchInput.addEventListener('input', function() {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(onFilterChange, 300);
                });
            }

            // Clear filters button
            var clearBtn = getElement('clear-filters-btn');
            if (clearBtn) {
                clearBtn.addEventListener('click', clearAllFilters);
            }
        });

        // Expose necessary functions to global scope for query cards partial
        window.filterByTag = filterByTag;
        window.filterByLogSource = filterByLogSource;
        window.onFilterChange = onFilterChange;

    })();
    </script>

</body>
</html>