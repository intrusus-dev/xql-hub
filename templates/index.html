<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XSIAM Hub</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
</head>
<body>

    <header>
        <a href="/" class="logo">XSIAM <span>HUB</span></a>
        <div class="header-controls">
            <div class="search-bar">
                <input type="text" name="q" id="search-input"
                       placeholder="Search queries..."
                       oninput="onFilterChange()">
            </div>
            <a href="/contribute" class="contribute-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Contribute
            </a>
        </div>
    </header>

    <div class="app-layout">
        <!-- Left Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-section">
                <h4 class="sidebar-title">Filters</h4>

                <div class="filter-group">
                    <label>Content Type</label>
                    <select name="content_type" id="filter-content-type" class="filter-select" onchange="onFilterChange()">
                        <option value="all">All Types</option>
                        {% for t in filters.types %}
                        <option value="{{ t }}">
                            {% if t == 'bioc' %}BIOC
                            {% elif t == 'hunting' %}Threat Hunting
                            {% elif t == 'hygiene' %}IT Hygiene
                            {% elif t == 'correlation' %}Correlation Rule
                            {% elif t == 'widget' %}Dashboard Widget
                            {% else %}{{ t|title }}
                            {% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label>Log Source</label>
                    <select name="log_source" id="filter-log-source" class="filter-select" onchange="onFilterChange()">
                        <option value="all">All Log Sources</option>
                        {% for ls in filters.log_sources %}
                        <option value="{{ ls }}">{{ ls }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label>Sort By</label>
                    <select name="sort_by" id="filter-sort" class="filter-select" onchange="onFilterChange()">
                        <option value="name">Name (A-Z)</option>
                        <option value="name-desc">Name (Z-A)</option>
                        <option value="severity">Severity (High first)</option>
                        <option value="type">Content Type</option>
                    </select>
                </div>
            </div>

            <div class="sidebar-section">
                <button type="button" class="clear-filters-btn" onclick="clearAllFilters()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 6h18M6 6v14a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V6M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/>
                    </svg>
                    Clear All Filters
                </button>
            </div>

            <!-- Contribute CTA in sidebar -->
            <div class="sidebar-section sidebar-cta">
                <div class="cta-card">
                    <div class="cta-icon">üéÅ</div>
                    <h4>Share Your Queries</h4>
                    <p>Help the community by contributing your detection content.</p>
                    <a href="/contribute" class="cta-btn">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        Contribute Now
                    </a>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <div class="main-area">
            <!-- MITRE ATT&CK Matrix -->
            <div class="mitre-matrix-container">
                <div class="mitre-matrix-header">
                    <h3>MITRE ATT&CK Matrix</h3>
                    <div class="mitre-stats">
                        <span class="stat-pill"><strong id="total-queries">{{ queries|length }}</strong> Queries</span>
                        <span class="stat-pill"><strong id="tactic-count">0</strong> Tactics</span>
                        <span class="stat-pill"><strong id="technique-count">0</strong> Techniques</span>
                    </div>
                </div>

                <div class="tactics-row" id="tactics-row">
                    <!-- Tactics will be populated by JS -->
                </div>

                <div class="selected-techniques" id="selected-display">
                    <span class="selected-label">Active Filters:</span>
                    <div class="selected-tags" id="selected-tags"></div>
                </div>
            </div>

            <!-- Main Content -->
            <main class="main-content">
                <div id="results-grid" class="grid">
                    {% include "partials/query_cards.html" %}
                </div>
            </main>
        </div>
    </div>

    <script>
        // All queries from the database (for dynamic filtering)
        const allQueries = {{ queries | tojson | safe }};

        // MITRE ATT&CK data with proper many-to-many tactic mappings (from mitre_data.json)
        const mitreData = {{ mitre_data | tojson | safe }};

        // Tactic definitions with full names
        const tactics = [
            { id: 'TA0043', name: 'Reconnaissance', shortname: 'Reconnaissance' },
            { id: 'TA0042', name: 'Resource Development', shortname: 'Resource Dev' },
            { id: 'TA0001', name: 'Initial Access', shortname: 'Initial Access' },
            { id: 'TA0002', name: 'Execution', shortname: 'Execution' },
            { id: 'TA0003', name: 'Persistence', shortname: 'Persistence' },
            { id: 'TA0004', name: 'Privilege Escalation', shortname: 'Priv Escalation' },
            { id: 'TA0005', name: 'Defense Evasion', shortname: 'Defense Evasion' },
            { id: 'TA0006', name: 'Credential Access', shortname: 'Cred Access' },
            { id: 'TA0007', name: 'Discovery', shortname: 'Discovery' },
            { id: 'TA0008', name: 'Lateral Movement', shortname: 'Lateral Move' },
            { id: 'TA0009', name: 'Collection', shortname: 'Collection' },
            { id: 'TA0011', name: 'Command and Control', shortname: 'C2' },
            { id: 'TA0010', name: 'Exfiltration', shortname: 'Exfiltration' },
            { id: 'TA0040', name: 'Impact', shortname: 'Impact' },
        ];

        // Build technique to tactic mapping from MITRE data (supports many-to-many relationships)
        function getTacticIdsForTechnique(techniqueId) {
            const baseId = techniqueId.split('.')[0];
            const mitreEntry = mitreData[techniqueId] || mitreData[baseId];
            return mitreEntry ? mitreEntry.tactic_ids : [];
        }

        // Get technique name from MITRE data
        function getTechniqueName(techniqueId) {
            const mitreEntry = mitreData[techniqueId];
            if (mitreEntry && mitreEntry.name) {
                return mitreEntry.name;
            }
            // Fallback to base technique name
            const baseId = techniqueId.split('.')[0];
            const baseEntry = mitreData[baseId];
            if (baseEntry && baseEntry.name) {
                return baseEntry.name;
            }
            return techniqueId;
        }

        // Selected MITRE techniques
        let selectedMitre = new Set();
        let expandedTactics = new Set();
        let selectedTag = null;

        // Get currently filtered queries based on dropdown selections
        function getFilteredQueries() {
            const contentType = document.getElementById('filter-content-type')?.value || 'all';
            const logSource = document.getElementById('filter-log-source')?.value || 'all';
            const searchQuery = document.getElementById('search-input')?.value?.toLowerCase() || '';

            return allQueries.filter(q => {
                if (contentType !== 'all' && q.content_type !== contentType) return false;
                if (logSource !== 'all' && !(q.log_sources || []).includes(logSource)) return false;
                if (searchQuery && !JSON.stringify(q).toLowerCase().includes(searchQuery)) return false;
                return true;
            });
        }

        // Get MITRE IDs from filtered queries
        function getMitreFromFilteredQueries() {
            const filtered = getFilteredQueries();
            const mitreIds = new Set();
            filtered.forEach(q => {
                (q.mitre_ids || []).forEach(mid => mitreIds.add(mid));
            });
            return Array.from(mitreIds);
        }

        // Count queries matching a specific technique (base or subtechnique)
        function countQueriesForTechnique(techniqueId) {
            const filtered = getFilteredQueries();
            return filtered.filter(q => {
                const queryMitre = q.mitre_ids || [];
                return queryMitre.some(mid => mid === techniqueId || mid.startsWith(techniqueId + '.'));
            }).length;
        }

        // Build/rebuild the MITRE matrix based on current filters
        function buildMitreMatrix() {
            const availableMitre = getMitreFromFilteredQueries();
            const tacticCounts = {};
            const tacticTechniques = {};
            const uniqueTechniques = new Set(); // Track unique base techniques globally

            // Initialize all tactics
            tactics.forEach(t => {
                tacticCounts[t.id] = 0;
                tacticTechniques[t.id] = new Map();
            });

            // Group techniques by tactic (MANY-TO-MANY: each technique can appear in multiple tactics)
            availableMitre.forEach(mid => {
                const baseId = mid.split('.')[0];
                uniqueTechniques.add(baseId); // Track unique base techniques
                const tacticIds = getTacticIdsForTechnique(mid);

                // Add this technique to ALL tactics it belongs to
                tacticIds.forEach(tacticId => {
                    if (!tacticTechniques[tacticId]) {
                        tacticTechniques[tacticId] = new Map();
                    }
                    if (!tacticTechniques[tacticId].has(baseId)) {
                        tacticTechniques[tacticId].set(baseId, []);
                    }
                    tacticTechniques[tacticId].get(baseId).push(mid);
                });
            });

            // Count unique techniques per tactic
            Object.keys(tacticTechniques).forEach(tacticId => {
                tacticCounts[tacticId] = tacticTechniques[tacticId].size;
            });

            // Build the UI
            const tacticsRow = document.getElementById('tactics-row');
            tacticsRow.innerHTML = '';

            let totalTactics = 0;

            tactics.forEach(tactic => {
                const count = tacticCounts[tactic.id];
                const techniques = tacticTechniques[tactic.id];

                if (count > 0) totalTactics++;

                const column = document.createElement('div');
                column.className = 'tactic-column';
                column.dataset.tacticId = tactic.id;

                const hasQueries = count > 0;
                const isExpanded = expandedTactics.has(tactic.id);

                column.innerHTML = `
                    <div class="tactic-header ${hasQueries ? 'has-queries' : ''} ${isExpanded ? 'expanded' : ''}" onclick="toggleTactic('${tactic.id}')">
                        <span class="tactic-count ${hasQueries ? 'has-queries' : 'zero'}">${count}</span>
                        <span class="tactic-name">${tactic.shortname}</span>
                        <span class="tactic-id">${tactic.id}</span>
                        ${hasQueries ? '<span class="tactic-expand-indicator">‚ñº</span>' : ''}
                    </div>
                    <div class="techniques-panel ${isExpanded ? 'expanded' : ''}" id="panel-${tactic.id}">
                        ${buildTechniquesPanel(techniques)}
                    </div>
                `;

                tacticsRow.appendChild(column);
            });

            // Update stats with UNIQUE technique count
            document.getElementById('tactic-count').textContent = totalTactics;
            document.getElementById('technique-count').textContent = uniqueTechniques.size;
            document.getElementById('total-queries').textContent = getFilteredQueries().length;

            // Re-apply selected state to technique cards
            selectedMitre.forEach(mid => {
                const cards = document.querySelectorAll(`[data-technique="${mid}"]`);
                cards.forEach(c => c.classList.add('selected'));
            });
        }

        function buildTechniquesPanel(techniques) {
            if (!techniques || techniques.size === 0) return '';

            let html = '';
            techniques.forEach((subtechniques, baseId) => {
                const name = getTechniqueName(baseId);
                // Count actual queries, not subtechniques
                const queryCount = countQueriesForTechnique(baseId);
                const isSelected = selectedMitre.has(baseId);

                html += `
                    <div class="technique-card ${isSelected ? 'selected' : ''}" data-technique="${baseId}" onclick="toggleTechnique('${baseId}')">
                        <div class="technique-card-header">
                            <span class="technique-card-name">${name}</span>
                            <span class="technique-card-count">${queryCount}</span>
                        </div>
                        <span class="technique-card-id">${baseId}</span>
                    </div>
                `;
            });

            return html;
        }

        function toggleTactic(tacticId) {
            const column = document.querySelector(`[data-tactic-id="${tacticId}"]`);
            const header = column.querySelector('.tactic-header');
            const panel = document.getElementById(`panel-${tacticId}`);

            if (!header.classList.contains('has-queries')) return;

            if (expandedTactics.has(tacticId)) {
                expandedTactics.delete(tacticId);
                header.classList.remove('expanded');
                panel.classList.remove('expanded');
            } else {
                expandedTactics.add(tacticId);
                header.classList.add('expanded');
                panel.classList.add('expanded');
            }
        }

        function toggleTechnique(techniqueId) {
            const cards = document.querySelectorAll(`[data-technique="${techniqueId}"]`);

            if (selectedMitre.has(techniqueId)) {
                selectedMitre.delete(techniqueId);
                cards.forEach(c => c.classList.remove('selected'));
            } else {
                selectedMitre.add(techniqueId);
                cards.forEach(c => c.classList.add('selected'));
            }

            updateSelectedDisplay();
            triggerSearch();
        }

        function filterByTag(tag) {
            selectedTag = tag;
            document.getElementById('search-input').value = tag;
            onFilterChange();
        }

        function updateSelectedDisplay() {
            const display = document.getElementById('selected-display');
            const tagsContainer = document.getElementById('selected-tags');

            if (selectedMitre.size === 0) {
                display.classList.remove('has-selection');
                tagsContainer.innerHTML = '';
            } else {
                display.classList.add('has-selection');
                tagsContainer.innerHTML = Array.from(selectedMitre).map(mid => {
                    const name = getTechniqueName(mid);
                    return `<span class="selected-tag" onclick="toggleTechnique('${mid}')">${name} <span class="remove">√ó</span></span>`;
                }).join('');
            }
        }

        function clearAllFilters() {
            // Clear MITRE selection
            selectedMitre.clear();
            selectedTag = null;
            document.querySelectorAll('.technique-card.selected').forEach(el => {
                el.classList.remove('selected');
            });

            // Reset dropdowns
            document.getElementById('filter-content-type').value = 'all';
            document.getElementById('filter-log-source').value = 'all';
            document.getElementById('search-input').value = '';

            updateSelectedDisplay();
            buildMitreMatrix();
            triggerSearch();
        }

        function onFilterChange() {
            // Rebuild MITRE matrix based on new filter state
            buildMitreMatrix();
            triggerSearch();
        }

        function triggerSearch() {
            const params = new URLSearchParams();

            const q = document.getElementById('search-input')?.value || '';
            if (q) params.append('q', q);

            const contentType = document.getElementById('filter-content-type')?.value || 'all';
            if (contentType !== 'all') params.append('content_type', contentType);

            const logSource = document.getElementById('filter-log-source')?.value || 'all';
            if (logSource !== 'all') params.append('log_source', logSource);

            selectedMitre.forEach(mid => params.append('mitre', mid));

            htmx.ajax('GET', `/search?${params.toString()}`, '#results-grid');
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', buildMitreMatrix);
    </script>

</body>
</html>