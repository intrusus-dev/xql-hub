{% for query in queries %}
<div class="card type-{{ query.content_type }}">
    <div class="card-header">
        <div class="header-top">
            {% if query.content_type == 'hunting' %}
            <span class="badge hunting">THREAT HUNTING</span>
            {% elif query.content_type == 'hygiene' %}
            <span class="badge hygiene">IT HYGIENE</span>
            {% elif query.content_type == 'bioc' %}
            <span class="badge bioc">BIOC</span>
            {% elif query.content_type == 'correlation' %}
            <span class="badge correlation">CORRELATION</span>
            {% elif query.content_type == 'widget' %}
            <span class="badge widget">WIDGET</span>
            {% else %}
            <span class="badge {{ query.content_type }}">{{ query.content_type|upper }}</span>
            {% endif %}
            {% if query.severity %}
            <span class="severity-badge severity-{{ query.severity|lower }}">{{ query.severity }}</span>
            {% endif %}
        </div>
        <h2>{{ query.name }}</h2>
        {% if query.author %}
        <div class="card-author">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
            </svg>
            {% if query.github %}
            <a href="https://github.com/{{ query.github | replace('@', '') }}" target="_blank" class="author-link" title="View GitHub profile">{{ query.author }}</a>
            {% else %}
            <span>{{ query.author }}</span>
            {% endif %}
        </div>
        {% endif %}
    </div>

    {% if query.mitre_ids %}
    <div class="mitre-section">
        {% for mid in query.mitre_ids %}
        <a href="https://attack.mitre.org/techniques/{{ mid.replace('.', '/') }}" target="_blank" class="mitre-tag">
            üéØ {{ mid }}
        </a>
        {% endfor %}
    </div>
    {% endif %}

    <p class="desc">{{ query.description }}</p>

    <div class="meta-tags">
        {% if query.log_sources %}
            {% for src in query.log_sources %}
            <span class="meta-tag log-source-tag" onclick="filterByLogSource('{{ src }}')" title="Click to filter by this log source">üìã {{ src }}</span>
            {% endfor %}
        {% endif %}
        {% if query.tags %}
            {% for tag in query.tags %}
            <span class="meta-tag query-tag" onclick="filterByTag('{{ tag }}')" title="Click to filter by this tag">{{ tag }}</span>
            {% endfor %}
        {% endif %}
    </div>

    <div class="code-preview">
        <button class="copy-btn" onclick="copyCode(this)" title="Copy to clipboard">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
        </button>
        <pre><code>{{ query.query }}</code></pre>
    </div>
</div>
{% endfor %}

{% if not queries %}
<div class="no-results">
    <div class="no-results-icon">üîç</div>
    <h3>No queries found</h3>
    <p>Try adjusting your filters or search terms</p>
</div>
{% endif %}

<script>
function copyCode(btn) {
    const code = btn.nextElementSibling.textContent;
    navigator.clipboard.writeText(code).then(() => {
        btn.classList.add('copied');
        setTimeout(() => btn.classList.remove('copied'), 2000);
    });
}

function filterByTag(tag) {
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
        searchInput.value = tag;
        if (typeof onFilterChange === 'function') {
            onFilterChange();
        }
    }
}

function filterByLogSource(logSource) {
    const logSourceSelect = document.getElementById('filter-log-source');
    if (logSourceSelect) {
        // Find and select the matching option
        for (let option of logSourceSelect.options) {
            if (option.value === logSource) {
                logSourceSelect.value = logSource;
                break;
            }
        }
        if (typeof onFilterChange === 'function') {
            onFilterChange();
        }
    }
}
</script>