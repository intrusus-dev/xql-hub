name: Validate Contribution

on:
  issues:
    types: [opened, edited]

jobs:
  validate:
    if: contains(github.event.issue.labels.*.name, 'contribution')
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Extract and Validate YAML
        id: validate
        run: |
          python << 'EOF'
          import yaml
          import re
          import sys
          import os
          
          issue_body = """${{ github.event.issue.body }}"""
          
          # Extract YAML from code block
          yaml_match = re.search(r'```ya?ml\s*(.*?)\s*```', issue_body, re.DOTALL)
          if not yaml_match:
              print("::error::No YAML code block found in issue body")
              sys.exit(1)
          
          yaml_content = yaml_match.group(1).strip()
          
          try:
              data = yaml.safe_load(yaml_content)
          except yaml.YAMLError as e:
              print(f"::error::Invalid YAML syntax: {e}")
              sys.exit(1)
          
          errors = []
          warnings = []
          
          # Required fields
          required = ['name', 'author', 'description', 'content_type', 'query']
          missing = [f for f in required if f not in data or not data[f]]
          if missing:
              errors.append(f"Missing required fields: {', '.join(missing)}")
          
          # Validate content_type
          valid_types = ['bioc', 'correlation', 'hunting', 'hygiene', 'widget']
          content_type = data.get('content_type', '')
          if content_type not in valid_types:
              errors.append(f"Invalid content_type '{content_type}'. Must be one of: {valid_types}")
          
          # BIOC-specific validation
          if content_type == 'bioc':
              query = data.get('query', '').lower()
              if 'xdr_data' not in query and 'cloud_audit_log' not in query:
                  errors.append("BIOC rules must use xdr_data or cloud_audit_log dataset")
              
              if 'event_type' not in query:
                  warnings.append("BIOC rules should filter on event_type")
              
              mitre_ids = data.get('mitre_ids', [])
              if len(mitre_ids) > 3:
                  errors.append("BIOC rules support maximum 3 MITRE techniques")
          
          # Widget-specific validation
          if content_type == 'widget':
              query = data.get('query', '').lower()
              if '| view' not in query:
                  warnings.append("Widget queries should include a | view statement for visualization")
          
          # Validate MITRE IDs
          for mid in data.get('mitre_ids', []):
              if not re.match(r'^T\d{4}(\.\d{3})?$', mid):
                  errors.append(f"Invalid MITRE technique ID format: {mid}")
          
          # Generate output
          if errors:
              print("VALIDATION_STATUS=failed")
              print(f"ERRORS={'; '.join(errors)}")
              sys.exit(1)
          else:
              # Generate filename
              name = data.get('name', 'unnamed')
              filename = re.sub(r'[^a-z0-9]+', '_', name.lower()).strip('_')
              
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write(f"filename={filename}\n")
                  f.write(f"content_type={content_type}\n")
                  f.write(f"warnings={'; '.join(warnings)}\n")
              
              print("‚úÖ Validation passed!")
              if warnings:
                  print(f"‚ö†Ô∏è Warnings: {'; '.join(warnings)}")
          EOF

      - name: Add validated label
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const warnings = '${{ steps.validate.outputs.warnings }}';
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['status: validated', 'type: ${{ steps.validate.outputs.content_type }}']
            });
            
            // Remove pending-review if present
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                name: 'status: pending-review'
              });
            } catch (e) {}
            
            let body = '‚úÖ **Validation Passed!**\n\nYour contribution has been validated and is ready for maintainer review.\n\n';
            body += `**Filename:** \`${{ steps.validate.outputs.filename }}.yaml\`\n`;
            body += `**Content Type:** ${{ steps.validate.outputs.content_type }}\n`;
            
            if (warnings) {
              body += `\n‚ö†Ô∏è **Warnings:**\n${warnings.split('; ').map(w => `- ${w}`).join('\n')}\n`;
            }
            
            body += '\n---\n*A maintainer will review your contribution shortly. Thank you for contributing to XQL Hub!* üéâ';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Report validation failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['status: needs-changes']
            });
            
            // Remove pending-review if present
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                name: 'status: pending-review'
              });
            } catch (e) {}
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `‚ùå **Validation Failed**
            
            Please check the workflow logs and fix the issues mentioned above.
            
            **Common issues:**
            - Missing required fields (name, author, description, content_type, query)
            - Invalid content_type (must be: bioc, correlation, hunting, hygiene, widget)
            - BIOC rules must use \`xdr_data\` or \`cloud_audit_log\` dataset
            - Invalid MITRE technique ID format (should be like T1059 or T1059.001)
            
            Please edit your issue to fix these problems and the validation will run again automatically.
            
            ---
            *Need help? Check our [contribution guide](https://github.com/intrusus-dev/xql-hub/blob/main/CONTRIBUTING.md) or use the [contribution wizard](https://xql-hub.com/contribute).*`
            });