name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  validate:
    name: Validate Queries
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pyyaml jsonschema

      - name: Validate all query YAML files
        run: |
          python << 'EOF'
          import yaml
          import os
          import sys
          
          REQUIRED_FIELDS = ['name', 'author', 'description', 'content_type', 'query']
          VALID_TYPES = ['bioc', 'correlation', 'hunting', 'hygiene', 'widget']
          VALID_SEVERITIES = ['informational', 'low', 'medium', 'high', 'critical']
          
          errors = []
          query_dir = 'queries'
          
          for root, dirs, files in os.walk(query_dir):
              for filename in files:
                  if not filename.endswith(('.yaml', '.yml')):
                      continue
                      
                  filepath = os.path.join(root, filename)
                  try:
                      with open(filepath, 'r') as f:
                          data = yaml.safe_load(f)
                      
                      # Check required fields
                      missing = [f for f in REQUIRED_FIELDS if f not in data or not data[f]]
                      if missing:
                          errors.append(f"{filepath}: Missing required fields: {missing}")
                          continue
                      
                      # Validate content_type
                      if data['content_type'] not in VALID_TYPES:
                          errors.append(f"{filepath}: Invalid content_type '{data['content_type']}'")
                      
                      # Validate severity if present
                      if 'severity' in data and data['severity'].lower() not in VALID_SEVERITIES:
                          errors.append(f"{filepath}: Invalid severity '{data['severity']}'")
                      
                      # BIOC-specific validation
                      if data['content_type'] == 'bioc':
                          query = data.get('query', '').lower()
                          if 'xdr_data' not in query and 'cloud_audit_log' not in query:
                              errors.append(f"{filepath}: BIOC must use xdr_data or cloud_audit_log dataset")
                          
                          mitre_ids = data.get('mitre_ids', [])
                          if len(mitre_ids) > 3:
                              errors.append(f"{filepath}: BIOC rules support max 3 MITRE techniques")
                      
                      # Validate MITRE IDs format
                      for mid in data.get('mitre_ids', []):
                          if not mid.startswith('T') or not mid[1:].replace('.', '').isdigit():
                              errors.append(f"{filepath}: Invalid MITRE ID format: {mid}")
                      
                      print(f"✓ {filepath}")
                      
                  except yaml.YAMLError as e:
                      errors.append(f"{filepath}: Invalid YAML syntax - {e}")
                  except Exception as e:
                      errors.append(f"{filepath}: Error - {e}")
          
          if errors:
              print("\n❌ Validation errors found:")
              for error in errors:
                  print(f"  - {error}")
              sys.exit(1)
          else:
              print(f"\n✅ All query files validated successfully!")
          EOF

  lint:
    name: Lint Python Code
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install linters
        run: |
          pip install flake8 black isort

      - name: Run flake8
        run: flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

      - name: Check formatting with black
        run: black --check --diff .
        continue-on-error: true

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest httpx

      - name: Run tests
        run: |
          pytest tests/ -v || echo "No tests found, skipping"

  check-duplicates:
    name: Check for Duplicate Queries
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check for duplicates
        run: |
          python << 'EOF'
          import yaml
          import os
          from collections import defaultdict
          
          queries_by_name = defaultdict(list)
          queries_by_hash = defaultdict(list)
          
          for root, dirs, files in os.walk('queries'):
              for filename in files:
                  if not filename.endswith(('.yaml', '.yml')):
                      continue
                  
                  filepath = os.path.join(root, filename)
                  with open(filepath, 'r') as f:
                      data = yaml.safe_load(f)
                  
                  name = data.get('name', '').lower().strip()
                  query = data.get('query', '').strip()
                  
                  queries_by_name[name].append(filepath)
                  queries_by_hash[hash(query)].append(filepath)
          
          duplicates = []
          for name, files in queries_by_name.items():
              if len(files) > 1:
                  duplicates.append(f"Duplicate name '{name}': {files}")
          
          for h, files in queries_by_hash.items():
              if len(files) > 1:
                  duplicates.append(f"Duplicate query content: {files}")
          
          if duplicates:
              print("⚠️ Potential duplicates found:")
              for d in duplicates:
                  print(f"  - {d}")
              # Warning only, don't fail
          else:
              print("✅ No duplicates found")
          EOF